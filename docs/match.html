<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Color Match Editor – Save to Local</title>
  <style>
    button, a, label {
      touch-action: manipulation;
    }
    body {
      font-family: 'Press Start 2P', monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: black;
      color: #F5E8D1;
      margin: 0px;
      font-size: 12px;
    }
    .image-container {
      display: flex;
      margin-bottom: 20px;
    }
    .image-box {
      width: 195px;
      aspect-ratio: 3/2;
      background-color: #252525;
      background-size: cover;
      background-position: center;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 16px;
      width: 40%;
      margin-bottom: 20px;
    }
    .control-group {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .label {
      flex: 1;
    }
    .buttons {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .buttons button {
      font-family: 'Press Start 2P', monospace;
      padding: 4px 8px;
      font-size: 12px;
      background: #252525;
      border: 1px solid #252525;
      border-radius: 2px;
      color: #F5E8D1;
    }
    .buttons .value {
      width: 50px;
      text-align: center;
    }
    .reset-button {
      font-family: 'Press Start 2P', monospace;
      margin-top: 10px;
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
      background: #252525;
      border: 1px solid #252525;
      border-radius: 2px;
      color: #F5E8D1;
    }
  </style>
</head>
<body>

  <h1>Color Match Editor</h1>

  <div class="image-container">
    <div id="beforeBox" class="image-box" title="Click to choose BEFORE image"></div>
    <div id="afterBox" class="image-box" title="Click to choose AFTER image"></div>
  </div>

  <div class="controls" id="controls"></div>
  <button class="reset-button" onclick="resetFilters()">Reset Filters</button>

  <input id="imageInput" type="file" accept="image/*" style="display: none;" />

  <svg style="position: absolute; width: 0; height: 0;">
    <filter id="colorMatrixFilter">
      <feComponentTransfer>
        <feFuncR type="gamma" amplitude="1" exponent="1" offset="0"/>
        <feFuncG type="gamma" amplitude="1" exponent="1" offset="0"/>
        <FeFuncB type="gamma" amplitude="1" exponent="1" offset="0"/>
      </feComponentTransfer>
      <feColorMatrix type="matrix" values="1 0 0 0 0
                                           0 1 0 0 0
                                           0 0 1 0 0
                                           0 0 0 1 0" />
    </filter>
  </svg>

  <script>
    const beforeBox = document.getElementById('beforeBox');
    const afterBox = document.getElementById('afterBox');
    const imageInput = document.getElementById('imageInput');
    const controlsDiv = document.getElementById('controls');
    let targetBox = null;

    const filters = [
      { id: 'brightness', label: 'Brig', min: 0, max: 200, step: 5, default: 100 },
      { id: 'contrast', label: 'Cont', min: 0, max: 200, step: 5, default: 100 },
      { id: 'saturate', label: 'Satu', min: 0, max: 200, step: 5, default: 100 },
      { id: 'grayscale', label: 'Gray', min: 0, max: 100, step: 5, default: 0 },
      { id: 'sepia', label: 'Sepi', min: 0, max: 100, step: 5, default: 0 },
      { id: 'gamma', label: 'Gama', min: 0.1, max: 5.0, step: 0.1, default: 1.0 }
    ];

    const values = {};
    const matrixLabels = ['R→R', 'R→G', 'R→B', 'G→R', 'G→G', 'G→B', 'B→R', 'B→G', 'B→B'];
    const colorMatrix = Array(9).fill(0).map((_, i) => (i % 4 === 0 ? 1 : 0)); // identity matrix

    function saveFilterState() {
      localStorage.setItem('filterValues', JSON.stringify(values));
      localStorage.setItem('colorMatrix', JSON.stringify(colorMatrix));
    }

    function loadFilterState() {
      const saved = localStorage.getItem('filterValues');
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          filters.forEach(f => {
            values[f.id] = parsed.hasOwnProperty(f.id) ? parsed[f.id] : f.default;
          });
        } catch (e) {
          filters.forEach(f => values[f.id] = f.default);
        }
      } else {
        filters.forEach(f => values[f.id] = f.default);
      }

      const savedMatrix = localStorage.getItem('colorMatrix');
      if (savedMatrix) {
        try {
          const parsedMatrix = JSON.parse(savedMatrix);
          parsedMatrix.forEach((v, i) => colorMatrix[i] = v);
        } catch (e) {}
      }
    }

    function createControls() {
      filters.forEach(f => {
        const group = document.createElement('div');
        group.className = 'control-group';

        const label = document.createElement('div');
        label.className = 'label';
        label.innerText = f.label;

        const buttons = document.createElement('div');
        buttons.className = 'buttons';

        const minus = document.createElement('button');
        minus.innerText = '–';
        minus.onclick = () => updateFilter(f.id, -f.step);

        const plus = document.createElement('button');
        plus.innerText = '+';
        plus.onclick = () => updateFilter(f.id, f.step);

        const valText = document.createElement('div');
        valText.className = 'value';
        valText.id = f.id + '_value';
        valText.innerText = values[f.id];

        buttons.append(minus, valText, plus);
        group.append(label, buttons);
        controlsDiv.appendChild(group);
      });

      matrixLabels.forEach((label, i) => {
        const group = document.createElement('div');
        group.className = 'control-group';

        const title = document.createElement('div');
        title.className = 'label';
        title.innerText = label;

        const buttons = document.createElement('div');
        buttons.className = 'buttons';

        const minus = document.createElement('button');
        minus.innerText = '–';
        minus.onclick = () => updateMatrix(i, -0.05);

        const plus = document.createElement('button');
        plus.innerText = '+';
        plus.onclick = () => updateMatrix(i, 0.05);

        const val = document.createElement('div');
        val.className = 'value';
        val.id = `matrix_${i}`;
        val.innerText = colorMatrix[i].toFixed(2);

        buttons.append(minus, val, plus);
        group.append(title, buttons);
        controlsDiv.appendChild(group);
      });
    }

    function updateFilter(id, delta) {
      const f = filters.find(f => f.id === id);
      let v = values[id] + delta;
      v = Math.round(v * 100) / 100;
      values[id] = Math.min(f.max, Math.max(f.min, v));
      document.getElementById(id + '_value').innerText = values[id];
      applyFilters();
      saveFilterState();
    }

    function updateMatrix(index, delta) {
      colorMatrix[index] = Math.max(-5, Math.min(5, colorMatrix[index] + delta));
      document.getElementById(`matrix_${index}`).innerText = colorMatrix[index].toFixed(2);
      applyColorMatrix();
      saveFilterState();
    }


    function applyFilters() {
      afterBox.style.filter = `
        brightness(${values.brightness}%)
        contrast(${values.contrast}%)
        saturate(${values.saturate}%)
        grayscale(${values.grayscale}%)
        sepia(${values.sepia}%)
        url(#colorMatrixFilter)
      `;
      applyColorMatrix(); // update gamma too
    }

    function applyColorMatrix() {
      const gamma = values.gamma || 1;
      document.querySelector('#colorMatrixFilter feFuncR').setAttribute('exponent', gamma);
      document.querySelector('#colorMatrixFilter feFuncG').setAttribute('exponent', gamma);
      document.querySelector('#colorMatrixFilter feFuncB').setAttribute('exponent', gamma);

      const matValues = `
        ${colorMatrix[0]} ${colorMatrix[1]} ${colorMatrix[2]} 0 0
        ${colorMatrix[3]} ${colorMatrix[4]} ${colorMatrix[5]} 0 0
        ${colorMatrix[6]} ${colorMatrix[7]} ${colorMatrix[8]} 0 0
        0 0 0 1 0
      `;
      const feColorMatrix = document.querySelector('#colorMatrixFilter feColorMatrix');
      feColorMatrix.setAttribute('values', matValues);
    }

    function resetFilters() {
      filters.forEach(f => {
        values[f.id] = f.default;
        document.getElementById(f.id + '_value').innerText = f.default;
      });
      applyFilters();
      saveFilterState();
    }

    function handleImageUpload(event) {
      const reader = new FileReader();
      reader.onload = function (e) {
        if (targetBox) {
          targetBox.style.backgroundImage = `url(${e.target.result})`;
        }
      };
      reader.readAsDataURL(event.target.files[0]);
    }

    function selectImageBox(box) {
      targetBox = box;
      imageInput.click();
    }

    beforeBox.onclick = () => selectImageBox(beforeBox);
    afterBox.onclick = () => selectImageBox(afterBox);
    imageInput.addEventListener('change', handleImageUpload);
    function handleImageUpload(event) {
  const reader = new FileReader();
  reader.onload = function (e) {
    if (targetBox) {
      targetBox.style.backgroundImage = `url(${e.target.result})`;

      // Lưu vào localStorage
      const key = (targetBox === beforeBox) ? 'beforeImage' : 'afterImage';
      localStorage.setItem(key, e.target.result);
    }
  };
  reader.readAsDataURL(event.target.files[0]);
}
function restoreImages() {
  const beforeImage = localStorage.getItem('beforeImage');
  const afterImage = localStorage.getItem('afterImage');

  if (beforeImage) beforeBox.style.backgroundImage = `url(${beforeImage})`;
  if (afterImage) afterBox.style.backgroundImage = `url(${afterImage})`;
}


    loadFilterState();
    createControls();
    applyFilters();
    restoreImages(); // ← thêm dòng này
  </script>
</body>
</html>
