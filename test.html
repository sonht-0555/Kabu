<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nhúng & Trích Xuất Dữ Liệu từ PNG</title>
</head>
<body>
    <h2>Nhúng & Trích Xuất Dữ Liệu từ PNG</h2>
    <input type="file" id="fileInput" accept="image/png">
    <input type="text" id="textInput" placeholder="Nhập dữ liệu cần nhúng">
    <button onclick="embedText()">Nhúng Dữ Liệu</button>
    <button onclick="extractText()">Trích Xuất Dữ Liệu</button>
    
    <p><b>Ảnh Gốc:</b></p>
    <img id="originalImg" style="max-width: 300px; display: none;">
    
    <p><b>Ảnh Đã Nhúng Dữ Liệu:</b></p>
    <img id="modifiedImg" style="max-width: 300px; display: none;">
    
    <p><b>Dữ Liệu Đã Trích Xuất:</b> <span id="extractedText">Chưa có dữ liệu</span></p>

    <script>
        let originalBase64 = "";

        document.getElementById("fileInput").addEventListener("change", function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.readAsDataURL(file); // Đọc file dạng Base64
            reader.onload = function() {
                originalBase64 = reader.result;
                document.getElementById("originalImg").src = originalBase64;
                document.getElementById("originalImg").style.display = "block";
            };
        });

        function embedText() {
            let text = document.getElementById("textInput").value;
            if (!originalBase64) {
                alert("Vui lòng chọn ảnh trước!");
                return;
            }
            let newBase64 = embedTextInPngBase64(originalBase64, text);
            document.getElementById("modifiedImg").src = newBase64;
            document.getElementById("modifiedImg").style.display = "block";
            originalBase64 = newBase64; // Cập nhật base64 mới
        }

        function extractText() {
            if (!originalBase64) {
                alert("Vui lòng chọn ảnh trước!");
                return;
            }
            let extractedText = extractTextFromPngBase64(originalBase64);
            document.getElementById("extractedText").innerText = extractedText || "Không có dữ liệu";
        }

        function embedTextInPngBase64(base64, text) {
            let byteCharacters = atob(base64.split(',')[1]);
            let byteArray = new Uint8Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteArray[i] = byteCharacters.charCodeAt(i);
            }
            let textChunk = new TextEncoder().encode("tEXtComment\x00" + text);
            let newArray = new Uint8Array(byteArray.length + textChunk.length);
            newArray.set(byteArray, 0);
            newArray.set(textChunk, byteArray.length);
            return "data:image/png;base64," + btoa(String.fromCharCode(...newArray));
        }

        function extractTextFromPngBase64(base64) {
            let byteCharacters = atob(base64.split(',')[1]);
            let textMarker = "tEXtComment\x00";
            let textStart = byteCharacters.indexOf(textMarker);
            if (textStart !== -1) {
                return byteCharacters.substring(textStart + textMarker.length);
            }
            return null;
        }
        
    </script>
</body>
</html>
